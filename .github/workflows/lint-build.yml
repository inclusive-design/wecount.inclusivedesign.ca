name: Lint assets and build site

on:
  push:
    branches:
      - dev
      - main
  pull_request_target:
    types: [opened, synchronize]
jobs:
  lint-build:
    runs-on: ubuntu-latest
    steps:
    - name: Get User Permission
      id: checkAccess
      uses: actions-cool/check-user-permission@v2
      with:
        require: write
        username: ${{ github.triggering_actor }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Check User Permission
      if: steps.checkAccess.outputs.require-result == 'false'
      run: |
        echo "${{ github.triggering_actor }} does not have permissions on this repo."
        echo "Current permission level is ${{ steps.checkAccess.outputs.user-permission }}"
        echo "Job originally triggered by ${{ github.actor }}"
        exit 1
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{  github.event.pull_request.head.sha }} # This is dangerous without the first access check
    - name: Cache node modules
      uses: actions/cache@v3
      with:
        path: node_modules
        key: ${{ runner.OS }}-build-${{ hashFiles('**/package-lock.json') }}
    - name: Install dependencies
      run: npm ci
    - name: Lint assets
      run: npm run lint
    - name: Build site
      run: npm run build
      env:
        AIRTABLE_BASE_DEV: ${{ secrets.AIRTABLE_BASE_DEV }}
        AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
